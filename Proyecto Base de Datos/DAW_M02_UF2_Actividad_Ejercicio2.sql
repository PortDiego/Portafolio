DROP DATABASE IF EXISTS PedidosDB;
CREATE DATABASE PedidosDB;
USE PedidosDB;

CREATE TABLE Oficina ( 
  codigo VARCHAR(2) PRIMARY KEY,
  ciudad VARCHAR(25) NOT NULL, 
  provincia VARCHAR(25) NOT NULL,
  objetivo INT,
  ventas INT
 );

CREATE TABLE Cliente ( 
  codigo  VARCHAR(3)  PRIMARY KEY,
  nombre   VARCHAR(25) NOT NULL, 
  CREDITO INT NOT NULL
  );

CREATE TABLE Vendedor ( 
  codigo VARCHAR(2) PRIMARY KEY,
  nombre VARCHAR(25) NOT NULL, 
  oficinaCodigo VARCHAR(2), -- FK
  cuota INT NOT NULL,
  ventas INT NOT NULL,
  edad INT NOT NULL,
  fechaAlta DATE NOT NULL,
  jefe VARCHAR(2), -- FK 
  categoria VARCHAR(25) NOT NULL,
  CONSTRAINT FK_Vendedor_Oficina FOREIGN KEY (oficinaCodigo) REFERENCES Oficina (codigo)
	ON UPDATE CASCADE ON DELETE RESTRICT,
  CONSTRAINT FK_Vendedor_Vendedor FOREIGN KEY (jefe) REFERENCES Vendedor (codigo)
	ON UPDATE CASCADE ON DELETE RESTRICT
);
    
CREATE TABLE Producto ( 
  codigo VARCHAR(5), 
  fabricante VARCHAR(3), 
  descripcion VARCHAR(25) NOT NULL, 
  precio DECIMAL(8,2) NOT NULL, 
  estoc INT NOT NULL, 
  PRIMARY KEY (codigo, fabricante));

CREATE TABLE Pedido ( 
  codigo VARCHAR(5) PRIMARY KEY , 
  clienteCodigo VARCHAR(3)  NOT NULL, 
  fecha DATE NOT NULL, 
  vendedorCodigo VARCHAR(2) NOT NULL, -- FK
  productoCodigo VARCHAR(5) NOT NULL, -- FK
  productoFabricante VARCHAR(3) NOT NULL, -- FK
  cantidad INT NOT NULL,
  CONSTRAINT FK_PEDIDO_Vendedor FOREIGN KEY (vendedorCodigo) REFERENCES Vendedor (codigo)
	ON UPDATE CASCADE ON DELETE RESTRICT,
  CONSTRAINT FK_PEDIDO_Cliente FOREIGN KEY (clienteCodigo) REFERENCES Cliente (codigo)
	ON UPDATE CASCADE ON DELETE RESTRICT,
  CONSTRAINT FK_PEDIDO_producto FOREIGN KEY (productoCodigo,productoFabricante) REFERENCES Producto (codigo,fabricante)
	ON UPDATE CASCADE ON DELETE RESTRICT
 );

-- *********  DATOS ************************
INSERT INTO Oficina VALUES ('11','ALFARRAS','LLEIDA',NULL,24000);
INSERT INTO Oficina VALUES ('12','OLOT','GERONA',46000,16305);
INSERT INTO Oficina VALUES ('14','AMPOSTA','TARRAGONA',NULL,NULL);
INSERT INTO Oficina VALUES ('21','ALCOBENDAS','MADRID',42000,48724);
INSERT INTO Oficina VALUES ('22','MATARO','BARCELONA',18000,20616);


INSERT INTO Vendedor VALUES ('6','SAMUEL PONT','11',16000,19741,52,'1995-01-14',NULL,'jefe DEPARTAMENTO');
INSERT INTO Vendedor VALUES ('9','MARIA MONS','11',18000,4259,31,'1996-10-12','6','REPRESENTANTE');
INSERT INTO Vendedor VALUES ('8','ALBERTO VILA','21',21000,25090,62,'1996-10-12','6','REPRESENTANTE');
INSERT INTO Vendedor VALUES ('4','ROBERT PEREZ','12',12000,0,33,'1994-05-19','6','jefe EQUIPO');
INSERT INTO Vendedor VALUES ('1','DANIEL BAS','12',18000,15945,45,'1993-02-13','4','REPRESENTANTE');
INSERT INTO Vendedor VALUES ('10','JUAN ARMENGOL',NULL,0,15109,41,'1997-01-13','1','REPRESENTANTE');
INSERT INTO Vendedor VALUES ('2','SUSANA PRAT','21',21000,13634,48,'1993-12-10','8','REPRESENTANTE');
INSERT INTO Vendedor  VALUES ('3','PABLO CASAS','12',16000,360,29,'1994-03-01','4','REPRESENTANTE');
INSERT INTO Vendedor  VALUES ('5','JUAN MAS','14',21000,25221,37,'1995-02-12','4','REPRESENTANTE');
INSERT INTO Vendedor  VALUES ('7','NIEVES PERA','14',18000,20616,49,'1995-11-14','8','REPRESENTANTE');

INSERT INTO Cliente VALUES ('101', 'CMB', 39000);
INSERT INTO Cliente VALUES ('102', 'JUAN ASOCIADOS', 39000);
INSERT INTO Cliente VALUES ('103', 'ACMR', 30000);
INSERT INTO Cliente VALUES ('105', 'INVERSIONES PUJOL', 27000);
INSERT INTO Cliente VALUES ('106', 'JUAN SALA CORPORATION',39000);
INSERT INTO Cliente VALUES ('107', 'PEPE, SL', 21000);
INSERT INTO Cliente VALUES ('108', 'JUAN Y PEDRO', 33000);
INSERT INTO Cliente VALUES ('109', 'EL BARATO', 15000);
INSERT INTO Cliente VALUES ('111', 'JPC, SA', 30000);
INSERT INTO Cliente VALUES ('112', 'CONSTRUCCIONES MARESME', 30000);
INSERT INTO Cliente VALUES ('113', 'NIEVES Y PILAR',12000);
INSERT INTO Cliente VALUES ('114', 'ORION', 12000);
INSERT INTO Cliente VALUES ('115', 'PEDRO CORPORATION', 12000);
INSERT INTO Cliente VALUES ('117', 'MODA JOVEN', 21000);
INSERT INTO Cliente VALUES ('118', 'SISTEMAS ASOCIADOS', 36000);
INSERT INTO Cliente VALUES ('119', 'VILLA MODA', 15000);
INSERT INTO Cliente VALUES ('120', 'EMPRESA RICO', 30000);
INSERT INTO Cliente VALUES ('121', 'QMC SAL', 27000);
INSERT INTO Cliente VALUES ('122', 'LA COMERCIAL', 18000);
INSERT INTO Cliente VALUES ('123', 'TADEO Y HIJOS', 24000);
INSERT INTO Cliente VALUES ('124', 'HERMANOS MARS', 24000);

INSERT INTO producto VALUES ('112','FEA','CUBIERTA',89,115);
INSERT INTO producto VALUES ('114','FEA','BANCADA MOTOR',146,15);
INSERT INTO producto VALUES ('2A44G','REI','PASADOR FRONTISA',210,14);
INSERT INTO producto VALUES ('2A44L','REI','FRONTISA IZQUIERDA.',2695,12);
INSERT INTO producto VALUES('2A44R','REI','FRONTISA DERECHA.',2695,12);
INSERT INTO producto VALUES('2A45C','REI','ARTICULO TIPO 5',47,210);
INSERT INTO producto VALUES('41001','ACI','ARTICULO TIPO 1',33,277);
INSERT INTO producto VALUES('41002','ACI','ARTICULO TIPO 2',46,167);
INSERT INTO producto VALUES('41003','ACI','ARTICULO TIPO 3',64,207);
INSERT INTO producto VALUES('41003','BIC','MANETA',390,3);
INSERT INTO producto VALUES('41004','ACI','ARTICULO TIPO 4',70,139);
INSERT INTO producto VALUES('4100X','ACI','AJUSTADOR',15,37);
INSERT INTO producto VALUES('4100Y','ACI','EXTRACTOR',1647,25);
INSERT INTO producto VALUES('4100Z','ACI','MONTADOR',1497,78);
INSERT INTO producto VALUES('41089','BIC','RETENEDOR',135,88);
INSERT INTO producto VALUES('41672','BIC','PLATO',108,0);
INSERT INTO producto VALUES('773C','IMM','RIOSTRA 0,5 TM',584,28);
INSERT INTO producto VALUES('775C','IMM','RIOSTRA 1 TM',853,5);
INSERT INTO producto VALUES('779C','IMM','RIOSTRA 2 TM',1123,9);
INSERT INTO producto VALUES('887H','IMM','SOPORTE RIOSTRA',32,223);
INSERT INTO producto VALUES('887X','IMM','RETENEDOR RIOSTRA',284,32);
INSERT INTO producto VALUES('XK47','QSA','REDUCTOR',213,38);
INSERT INTO producto VALUES('XK48','IMM','REDUCTOR',80,203);
INSERT INTO producto VALUES('XK48A','QSA','REDUCTOR',70,37);

INSERT INTO PEDIDO VALUES('10036','107','2012-01-30','10','4100Z','ACI','9');
INSERT INTO PEDIDO VALUES('12961','117','2015-12-17','6','2A44L','REI','7');
INSERT INTO PEDIDO VALUES('12963','103','2015-12-17','5','41004','ACI','28');
INSERT INTO PEDIDO VALUES('12965','111','2011-10-12','10','2A44G','REI','6');
INSERT INTO PEDIDO VALUES('12968','102','2011-10-12','1','41004','ACI','34');
INSERT INTO PEDIDO VALUES('12979','114','2015-10-12','2','4100Z','ACI','6');
INSERT INTO PEDIDO VALUES('12983','103','2015-12-27','5','41004','ACI','6');
INSERT INTO PEDIDO VALUES('12987','103','2000-12-31','5','4100Y','ACI','11');
INSERT INTO PEDIDO VALUES('12989','101','2012-01-12','6','114','FEA','6');
INSERT INTO PEDIDO VALUES('12992','118','2011-11-08','8','41002','ACI','10');
INSERT INTO PEDIDO VALUES('12993','106','2017-01-04','2','2A45C','REI','24');
INSERT INTO PEDIDO VALUES('12997','124','2017-01-07','7','41003','BIC','1');
INSERT INTO PEDIDO VALUES('13024','114','2012-01-12','8','XK47','QSA','20');
INSERT INTO PEDIDO VALUES('13003','108','2011-01-23','9','779C','IMM','3');
INSERT INTO PEDIDO VALUES('13042','113','2011-03-11','1','2A44R','REI','5');
INSERT INTO PEDIDO VALUES('13007','112','2012-6-28','8','773C','IMM','3');
INSERT INTO PEDIDO VALUES('13012','111','2014-07-18','5','41003','ACI','35');
INSERT INTO PEDIDO VALUES('13013','118','2012-09-24','8','41003','BIC','1');
INSERT INTO PEDIDO VALUES('13027','103','2012-04-06','5','41002','ACI','54');
INSERT INTO PEDIDO VALUES('13034','107','2012-07-05','10','2A45C','REI','8');
INSERT INTO PEDIDO VALUES('13045','112','2011-03-22','8','2A44R','REI','10');
INSERT INTO PEDIDO VALUES('13048','120','2012-10-12','2','779C','IMM','2');
INSERT INTO PEDIDO VALUES('13049','118','2012-02-17','8','XK47','QSA','2');
INSERT INTO PEDIDO VALUES('13051','118','2002-04-20','8','XK47','QSA','4');
INSERT INTO PEDIDO VALUES('13055','108','2012-08-12','1','4100X','ACI','6');
INSERT INTO PEDIDO VALUES('13057','111','2012-05-08','3','4100X','ACI','24');
INSERT INTO PEDIDO VALUES('13058','108','2012-07-23','9','112','FEA','10');
INSERT INTO PEDIDO VALUES('13062','124','2002-02-24','7','114','FEA','10');
INSERT INTO PEDIDO VALUES('13065','106','2012-07-22','2','XK47','QSA','6');
INSERT INTO PEDIDO VALUES('13069','109','2002-03-02','7','775C','IMM','22');

-- 1º
SELECT nombre, edad, YEAR(fechaAlta) AS Año FROM Vendedor
WHERE YEAR(fechaAlta) = 1996
ORDER BY edad DESC;

-- 2º
SELECT ciudad, COUNT(*) AS 'Cantidad Oficinas' FROM Oficina
GROUP BY ciudad
ORDER BY 'Cantidad Oficinas' DESC;

-- 3º
SELECT codigo, clienteCodigo, productoCodigo, productoFabricante, YEAR(fecha) AS Año 
FROM pedido
WHERE productoFabricante = 'ACI'
AND YEAR(fecha) = 2012;

-- 4º
SELECT descripcion, precio FROM producto
WHERE descripcion LIKE '%TM%'AND precio<1000;

-- 5º
SELECT * FROM Vendedor
WHERE categoria IN ('REPRESENTANTE', 'jefe EQUIPO');

-- 6º
SELECT A.nombre, P.cantidad FROM Vendedor A
	INNER JOIN pedido P ON A.codigo= P.vendedorCodigo
WHERE cantidad IN (6, 8, 12, 24);

-- 7º
SELECT N.oficinaCodigo, COUNT(*) AS 'Num Vendedores' 
FROM Oficina A
	LEFT JOIN Vendedor N ON A.codigo= N.oficinaCodigo
GROUP BY N.oficinaCodigo;

-- 8º
SELECT nombre, edad, oficinaCodigo FROM Vendedor
WHERE edad > (SELECT edad FROM Vendedor
	            WHERE nombre = 'Maria Mons')
AND oficinaCodigo= 21
GROUP BY nombre, edad, oficinaCodigo
ORDER BY edad DESC;

-- 9º
SELECT fabricante, SUM(estoc) AS 'Total Productos' 
FROM producto
GROUP BY fabricante
HAVING SUM(estoc) > 100;

-- 10º
SELECT nombre, ventas FROM Vendedor
WHERE ventas= (SELECT MAX(ventas) FROM Vendedor);

-- 11º
SELECT A.nombre, N.ciudad, M.cantidad AS 'Cantidad Total' 
FROM Vendedor A
	INNER JOIN Oficina N ON N.codigo= A.oficinaCodigo
    INNER JOIN pedido M ON A.codigo= M.vendedorCodigo
WHERE M.cantidad > 40 AND N.provincia <>'Tarragona'
GROUP BY A.nombre, N.ciudad, M.cantidad;

-- 12º
SELECT nombre, ventas, cuota, SUM(cuota) *1.1 AS 'NuevaCuota' 
FROM Vendedor
WHERE oficinaCodigo IS NOT NULL
GROUP BY nombre, ventas, cuota;

-- 13º
CREATE TABLE pedidos2000 SELECT * FROM pedido WHERE fecha < '2010-01-01';

-- 14º
ALTER TABLE Vendedor ADD COLUMN antiguedad INT AFTER fechaAlta;
UPDATE Vendedor 
SET antiguedad= CASE
	WHEN categoria = 'REPRESENTANTE' THEN 5
    ELSE 2
END;

-- 15º
UPDATE cliente
SET credito= CASE 
	WHEN credito <20000 THEN credito*1.1
    ELSE credito
END;

-- 16º
ALTER TABLE Vendedor MODIFY COLUMN nombre VARCHAR(40);

-- 17º
DELETE P.* FROM pedido P
	INNER JOIN cliente C ON C.codigo= P.clienteCodigo
WHERE P.fecha< '2011-01-01' AND C.nombre= 'ACMR';

-- 18º
UPDATE Oficina
SET objetivo= objetivo- 5000
WHERE provincia IN ('Madrid', 'Barcelona');



select * from Oficina;
select * from Vendedor;
select * from pedido;
select * from producto;
SELECT * FROM cliente;



